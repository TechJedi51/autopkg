<?xml version="1.0" encoding="UTF-8"?>
<recipe xmlns="https://github.com/autopkg/autopkg">
    <identifier>com.example.munki.bartender5.download</identifier>
    <parentRecipe>com.github.autopkg.download</parentRecipe>
    <description>Downloads the latest version of Bartender 5.</description>
    <minimum_version>2.0</minimum_version>

    <inputs>
        <Input key="NAME" value="Bartender"/>
        <Input key="appcast_url" value="https://www.macbartender.com/B2/updates/AppcastB5.xml"/>
        <Input key="filename" value="%NAME%.zip"/>
    </inputs>

    <process>
        <!-- Fetch and parse the appcast to get the latest version and download URL -->
        <Processor>URLTextSearcher</Processor>
        <Arguments>
            <Argument key="url" value="%appcast_url%"/>
            <Argument key="re_pattern">
                <string>(https://macbartender.com/B2/updates/[^"]+/Bartender[^\"]+.zip)</string>
            </Argument>
            <Argument key="result_output_var_name" value="download_url"/>
        </Arguments>

        <!-- Extract the version number from the download URL -->
        <Processor>Versioner</Processor>
        <Arguments>
            <Argument key="input_plist_path" value="%download_url%"/>
            <Argument key="re_pattern">
                <string>updates/([0-9.-]+)/Bartender</string>
            </Argument>
            <Argument key="version_output_var_name" value="version"/>
        </Arguments>

        <!-- Download the latest version using the extracted URL -->
        <Processor>URLDownloader</Processor>
        <Arguments>
            <Argument key="url" value="%download_url%"/>
            <Argument key="filename" value="%filename%"/>
        </Arguments>

        <!-- End of the download phase -->
        <Processor>EndOfCheckPhase</Processor>
    </process>
</recipe>
